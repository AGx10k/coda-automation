---
- hosts: all
  vars:
    s3_key_bucket: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          39323063353432636535616535393536613333633166363936396238353536383439336666653165
          3733656236633363323838626662343139353431353163390a663065616435393966653234323232
          37353233656235643534656631343362613263396532626565353463376238306139646465393466
          6535386336653336330a653662613534303038383831663838373932646136343635616337646366
          33616639383930373163653438633037313464643534653030313437633238643163323962633561
          39353462623133303966343161373330663030306538633838636161316530366664363631326261
          646265326131346432613633653836333737
  strategy: free
  gather_facts: no
  tasks:
    - include: tasks/task-varlibcoda.yaml
    - include: tasks/task-pvdownload.yaml
    - include: tasks/task-pvextract.yaml
    - include: tasks/task-installcoda.yaml
    - include: tasks/task-testkeys.yaml
    - include: tasks/task-sshkeys.yaml
    - include: tasks/task-tools.yaml
    - include: tasks/task-install-filebeat.yaml

# Assign a unique ID to each proposer (so proof of stake works)
- hosts: tag_role_proposer
  gather_facts: no
  tasks:
    - name: Unique ID
      copy:
        dest: /etc/coda-proposer_order
        content: "{{ ansible_play_hosts.index(inventory_hostname) }}"
      become: true
